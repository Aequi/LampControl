<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LED Controller BLE</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      color: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
      font-weight: 500;
      color: #00d4ff;
    }
    .controls { display: flex; gap: 10px; margin-bottom: 20px; }
    button {
      background: #1e1e1e; border: 1px solid #333;
      border-radius: 8px; padding: 10px 16px;
      color: #eee; font-size: 14px;
      cursor: pointer; transition: all 0.2s;
    }
    button:hover { background: #333; }
    #carousel {
      width: 300px; height: 400px; position: relative;
      overflow: hidden; border-radius: 12px; border: 1px solid #333;
      background: #000;
    }
    .slides { display: flex; transition: transform 0.4s ease; height: 100%; }
    .slide { min-width: 300px; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    canvas { background: #000; border-radius: 8px; border: 1px solid #333; }
    #log {
      margin-top: 20px; background: #1e1e1e;
      padding: 10px; border-radius: 8px;
      width: 90%; max-width: 600px; height: 150px;
      overflow-y: auto; font-family: monospace; font-size: 13px; border: 1px solid #333;
    }
    .nav { margin-top: 10px; display: flex; justify-content: center; gap: 20px; }
    .dot { width: 12px; height: 12px; border-radius: 50%; background: #555; cursor: pointer; }
    .dot.active { background: #00d4ff; }
  </style>
</head>
<body>
  <h1>LED Controller BLE</h1>
  <div class="controls">
    <button id="connect">üîó Connect</button>
    <button id="disconnect">‚ùå Disconnect</button>
  </div>

  <div id="carousel">
    <div class="slides">
      <div class="slide"><canvas id="rainbow" width="80" height="256"></canvas><p>üåà Rainbow</p></div>
      <div class="slide"><canvas id="chase" width="80" height="256"></canvas><p>üåä Theater Chase</p></div>
      <div class="slide"><canvas id="solid" width="80" height="256"></canvas><p>üí° Solid Color</p></div>
      <div class="slide"><canvas id="fire" width="80" height="256"></canvas><p>üî• Fire Flicker</p></div>
      <div class="slide"><canvas id="twinkle" width="80" height="256"></canvas><p>‚ùÑÔ∏è Twinkle</p></div>
      <div class="slide"><canvas id="strobe" width="80" height="256"></canvas><p>‚ö° Strobe</p></div>
      <div class="slide"><canvas id="gradient" width="80" height="256"></canvas><p>üé® Gradient</p></div>
    </div>
  </div>
  <div class="nav"></div>

  <div id="log"></div>

  <script>
    const SERVICE_UUID = "5f980001-011a-4d81-840f-619f447ae9d0";
    const WRITE_CHAR_UUID = "5f980002-011a-4d81-840f-619f447ae9d0";
    const READ_CHAR_UUID  = "5f980003-011a-4d81-840f-619f447ae9d0";
    const NUM_LEDS = 256;
    const WIDTH = 8, HEIGHT = 32; // matrix layout
    const CHUNK_SIZES = [80, 80, 80, 16];
    const CHUNK_OFFSETS = [0, 80, 160, 240];

    let writeCharacteristic, readCharacteristic, device, server;
    let running = false;
    let currentEffectIndex = 0;
    const slides = document.querySelector(".slides");
    const nav = document.querySelector(".nav");
    const effects = ["rainbow","chase","solid","fire","twinkle","strobe","gradient"];

    function log(msg) {
      const div = document.getElementById("log");
      div.textContent += msg + "\n";
      div.scrollTop = div.scrollHeight;
    }

    function hsvToRgb(h,s,v){
      let i=Math.floor(h*6);
      let f=h*6-i;
      let p=v*(1-s);
      let q=v*(1-f*s);
      let t=v*(1-(1-f)*s);
      let r,g,b;
      switch(i%6){
        case 0:r=v,g=t,b=p;break;
        case 1:r=q,g=v,b=p;break;
        case 2:r=p,g=v,b=t;break;
        case 3:r=p,g=q,b=v;break;
        case 4:r=t,g=p,b=v;break;
        case 5:r=v,g=p,b=q;break;
      }
      return [Math.round(r*255),Math.round(g*255),Math.round(b*255)];
    }

    // --- effect frames ---
    function frameRainbow(shift){
      let frame=[];
      for(let i=0;i<NUM_LEDS;i++){
        let hue=((i+shift)%NUM_LEDS)/NUM_LEDS;
        frame.push(...hsvToRgb(hue,1,1));
      }
      return frame;
    }
    function frameChase(shift){
      let frame=[];
      for(let i=0;i<NUM_LEDS;i++){
        if((i+shift)%10<3) frame.push(255,255,255);
        else frame.push(0,0,0);
      }
      return frame;
    }
    function frameSolid(color=[0,128,255]){
      return Array(NUM_LEDS).fill().flatMap(()=>color);
    }
    function frameFire(t){
      let frame=[];
      for(let y=0;y<HEIGHT;y++){
        for(let x=0;x<WIDTH;x++){
          let idx=y*WIDTH+x;
          let intensity=Math.floor(
            128+128*Math.sin((t/10)+(y/3)+(x/2))
          );
          let r=intensity, g=Math.floor(intensity*0.4), b=0;
          frame.push(r,g,b);
        }
      }
      return frame;
    }
    function frameTwinkle(){
      let frame=[];
      for(let i=0;i<NUM_LEDS;i++){
        if(Math.random()<0.05) frame.push(255,255,255);
        else frame.push(0,0,20);
      }
      return frame;
    }
    function frameStrobe(on){
      let frame=[];
      for(let i=0;i<NUM_LEDS;i++){
        if(on) frame.push(255,255,255);
        else frame.push(0,0,0);
      }
      return frame;
    }
    function frameGradient(shift){
      let frame=[];
      for(let y=0;y<HEIGHT;y++){
        for(let x=0;x<WIDTH;x++){
          let r=Math.floor(255*(x/WIDTH));
          let b=Math.floor(255*(y/HEIGHT));
          let g=(shift*5)%255;
          frame.push(r,g,b);
        }
      }
      return frame;
    }

    // --- drawing matrix (8√ó32) ---
    function drawFrame(canvasId, frame){
      let canvas=document.getElementById(canvasId);
      if(!canvas) return;
      let ctx=canvas.getContext("2d");
      let cellW=canvas.width/WIDTH;
      let cellH=canvas.height/HEIGHT;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(let y=0;y<HEIGHT;y++){
        for(let x=0;x<WIDTH;x++){
          let idx=(y*WIDTH+x)*3;
          let r=frame[idx], g=frame[idx+1], b=frame[idx+2];
          ctx.fillStyle=`rgb(${r},${g},${b})`;
          ctx.fillRect(x*cellW,y*cellH,cellW,cellH);
        }
      }
    }

    // --- BLE send ---
    async function sendFrameBLE(frame) {
      if (!writeCharacteristic) return;
      for (let i=0; i<CHUNK_SIZES.length; i++) {
        let offset = CHUNK_OFFSETS[i];
        let count = CHUNK_SIZES[i];
        let start = offset * 3;
        let end = start + count * 3;
        let rgbChunk = frame.slice(start, end);
        let trigger = (i === CHUNK_SIZES.length - 1) ? 1 : 0;
        let packet = [1, trigger, offset, count, ...rgbChunk];
        await writeCharacteristic.writeValue(new Uint8Array(packet));
      }
    }

    // --- carousel nav ---
    function updateCarousel(){
      slides.style.transform=`translateX(-${currentEffectIndex*300}px)`;
      document.querySelectorAll(".dot").forEach((d,i)=>d.classList.toggle("active",i===currentEffectIndex));
    }
    effects.forEach((e,i)=>{
      let dot=document.createElement("div");
      dot.classList.add("dot");
      if(i===0) dot.classList.add("active");
      dot.addEventListener("click",()=>{currentEffectIndex=i;updateCarousel();});
      nav.appendChild(dot);
    });

    let startX=0;
    slides.addEventListener("touchstart",e=>startX=e.touches[0].clientX);
    slides.addEventListener("touchend",e=>{
      let dx=e.changedTouches[0].clientX-startX;
      if(dx>50 && currentEffectIndex>0) currentEffectIndex--;
      if(dx<-50 && currentEffectIndex<effects.length-1) currentEffectIndex++;
      updateCarousel();
    });

    // --- effect loop ---
    async function runEffects(){
      let shift=0,on=true;
      running=true;
      while(running){
        let f=effects[currentEffectIndex];
        let frame;
        switch(f){
          case "rainbow": frame=frameRainbow(shift); break;
          case "chase": frame=frameChase(shift); break;
          case "solid": frame=frameSolid(); break;
          case "fire": frame=frameFire(shift); break;
          case "twinkle": frame=frameTwinkle(); break;
          case "strobe": frame=frameStrobe(on); on=!on; break;
          case "gradient": frame=frameGradient(shift); break;
        }
        drawFrame(f,frame);
        await sendFrameBLE(frame);
        shift++;
        await new Promise(r=>setTimeout(r,100));
      }
    }

    // --- BLE connect/disconnect ---
    document.getElementById("connect").addEventListener("click",async()=>{
      try {
        log("Requesting device...");
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        log("Connecting...");
        server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        writeCharacteristic = await service.getCharacteristic(WRITE_CHAR_UUID);
        readCharacteristic  = await service.getCharacteristic(READ_CHAR_UUID);

        await readCharacteristic.startNotifications();
        readCharacteristic.addEventListener("characteristicvaluechanged", e=>{
          const bytes=new Uint8Array(e.target.value.buffer);
          log("Notification: " + Array.from(bytes).map(b=>b.toString(16).padStart(2,"0")).join(" "));
        });

        log("‚úÖ Connected. Starting effects...");
        running=false;
        runEffects();
      } catch(err) {
        log("Error: "+err);
      }
    });

    document.getElementById("disconnect").addEventListener("click",()=>{
      if(device && device.gatt.connected) device.gatt.disconnect();
      log("‚ùå Disconnected.");
      running=false;
    });
  </script>
</body>
</html>
